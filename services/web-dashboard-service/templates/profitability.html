<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Profitability Analysis - Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-excellent { background-color: #10b981; }
        .status-good { background-color: #3b82f6; }
        .status-fair { background-color: #f59e0b; }
        .status-poor { background-color: #ef4444; }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-full-width { width: 100%; }
            .mobile-text-sm { font-size: 0.875rem; }
            .mobile-text-xs { font-size: 0.75rem; }
            .mobile-p-3 { padding: 0.75rem; }
            .mobile-mb-4 { margin-bottom: 1rem; }
            .mobile-grid-1 { grid-template-columns: 1fr; }
            .mobile-flex-col { flex-direction: column; }
            .mobile-space-y-2 > * + * { margin-top: 0.5rem; }
        }
        
        /* Smooth animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Progress bars */
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #3b82f6, #f59e0b, #ef4444);
        }
        
        /* Alert styles */
        .alert-high { border-left: 4px solid #ef4444; }
        .alert-medium { border-left: 4px solid #f59e0b; }
        .alert-low { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Profitability Analysis
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-1"></i>Dashboard
                    </a>
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading profitability data...</p>
        </div>

        <!-- Content Container -->
        <div id="content" class="hidden">
            <!-- Health Score Overview -->
            <div class="mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                            Profitability Health Score
                        </h2>
                        <div class="text-right">
                            <div id="healthScore" class="text-3xl font-bold text-green-600">--</div>
                            <div id="healthLevel" class="text-sm text-gray-600">--</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="healthBar" class="progress-bar h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Win Rate -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-green-100">
                            <i class="fas fa-trophy text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Win Rate</p>
                            <p id="winRate" class="text-2xl font-bold text-gray-900">--</p>
                        </div>
                    </div>
                </div>

                <!-- Profit Factor -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-blue-100">
                            <i class="fas fa-chart-bar text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Profit Factor</p>
                            <p id="profitFactor" class="text-2xl font-bold text-gray-900">--</p>
                        </div>
                    </div>
                </div>

                <!-- Total PnL -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-purple-100">
                            <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total PnL</p>
                            <p id="totalPnl" class="text-2xl font-bold text-gray-900">--</p>
                        </div>
                    </div>
                </div>

                <!-- Trades per Cycle -->
                <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-orange-100">
                            <i class="fas fa-exchange-alt text-orange-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Trades/Cycle</p>
                            <p id="tradesPerCycle" class="text-2xl font-bold text-gray-900">--</p>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Optimization Recommendations -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                        Optimization Recommendations
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="runOptimization(false)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-search mr-1"></i>Analyze
                        </button>
                        <button onclick="runOptimization(true)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-magic mr-1"></i>Auto-Optimize
                        </button>
                    </div>
                </div>
                <div id="recommendations" class="space-y-4">
                    <!-- Recommendations will be populated here -->
                </div>
                
                <!-- Optimization Status -->
                <div id="optimizationStatus" class="mt-6 p-4 bg-gray-50 rounded-md hidden">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                        <span class="text-sm text-gray-600">Running optimization analysis...</span>
                    </div>
                </div>
                
                <!-- Last Optimization Results -->
                <div id="lastOptimization" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md hidden">
                    <h4 class="text-sm font-medium text-blue-900 mb-2">Last Optimization Results</h4>
                    <div id="optimizationResults" class="text-sm text-blue-800">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                
                <!-- Comprehensive Optimization Output -->
                <div id="comprehensiveOutput" class="mt-6 hidden">
                    <!-- Optimization Summary -->
                    <div class="bg-white border border-gray-200 rounded-md p-4 mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                            Optimization Summary
                        </h4>
                        <div id="optimizationSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Detailed Changes -->
                    <div class="bg-white border border-gray-200 rounded-md p-4 mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fas fa-cogs text-green-600 mr-2"></i>
                            Recommended Changes
                        </h4>
                        <div id="detailedChanges" class="space-y-3">
                            <!-- Changes will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Config.yaml Snippet -->
                    <div class="bg-white border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-file-code text-purple-600 mr-2"></i>
                                Config.yaml Changes
                            </h4>
                            <button onclick="copyConfigSnippet()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <div class="bg-gray-900 text-green-400 p-4 rounded-md overflow-x-auto">
                            <pre id="configSnippet" class="text-sm"><code># Click "Analyze" or "Auto-Optimize" to generate config changes</code></pre>
                        </div>
                    </div>
                    
                    <!-- Full Config.yaml -->
                    <div class="bg-white border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-900">
                                <i class="fas fa-file-alt text-orange-600 mr-2"></i>
                                Complete Config.yaml
                            </h4>
                            <button onclick="copyFullConfig()" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-copy mr-1"></i>Copy Full
                            </button>
                        </div>
                        <div class="bg-gray-900 text-green-400 p-4 rounded-md overflow-x-auto max-h-96">
                            <pre id="fullConfig" class="text-sm"><code># Click "Analyze" or "Auto-Optimize" to generate complete config</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Performance Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Exchange Performance -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-building text-gray-600 mr-2"></i>
                        Exchange Performance
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exchange</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Win Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trades</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PnL</th>
                                </tr>
                            </thead>
                            <tbody id="exchangeTable" class="bg-white divide-y divide-gray-200">
                                <!-- Exchange data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Strategy Performance -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-brain text-purple-600 mr-2"></i>
                        Strategy Performance
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Win Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trades</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PnL</th>
                                </tr>
                            </thead>
                            <tbody id="strategyTable" class="bg-white divide-y divide-gray-200">
                                <!-- Strategy data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Risk Management -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-shield-alt text-red-600 mr-2"></i>
                    Risk Management
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900" id="maxDrawdown">--</div>
                        <div class="text-sm text-gray-600">Max Drawdown</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900" id="sharpeRatio">--</div>
                        <div class="text-sm text-gray-600">Sharpe Ratio</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900" id="balanceUtilization">--</div>
                        <div class="text-sm text-gray-600">Balance Utilization</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Fetch and display profitability data
        async function fetchProfitabilityData() {
            try {
                const response = await fetch('/api/v1/profitability');
                const data = await response.json();
                displayProfitabilityData(data);
            } catch (error) {
                console.error('Error fetching profitability data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Error loading profitability data</p>
                    </div>
                `;
            }
        }

        // Display profitability data
        function displayProfitabilityData(data) {
            // Hide loading, show content
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Update health score
            const healthScore = data.health_score || 0;
            const healthLevel = getHealthLevel(healthScore);
            document.getElementById('healthScore').textContent = healthScore;
            document.getElementById('healthLevel').textContent = healthLevel;
            document.getElementById('healthBar').style.width = `${healthScore}%`;

            // Update key metrics
            document.getElementById('winRate').textContent = `${(data.win_rate * 100).toFixed(1)}%`;
            document.getElementById('profitFactor').textContent = data.profit_factor.toFixed(2);
            document.getElementById('totalPnl').textContent = `$${data.total_pnl.toFixed(2)}`;
            document.getElementById('tradesPerCycle').textContent = data.trades_per_cycle.toFixed(3);

            // Update risk metrics
            document.getElementById('maxDrawdown').textContent = `${(data.max_drawdown * 100).toFixed(1)}%`;
            document.getElementById('sharpeRatio').textContent = data.sharpe_ratio.toFixed(2);
            document.getElementById('balanceUtilization').textContent = `${(data.balance_utilization * 100).toFixed(1)}%`;

            // Update tables
            updateExchangeTable(data.exchange_stats);
            updateStrategyTable(data.strategy_stats);

            // Recommendations are now handled by the Comprehensive Strategy Optimizer
        }

        // Get health level
        function getHealthLevel(score) {
            if (score >= 80) return 'Excellent';
            if (score >= 60) return 'Good';
            if (score >= 40) return 'Fair';
            return 'Poor';
        }

        // Update exchange table
        function updateExchangeTable(exchangeStats) {
            const tbody = document.getElementById('exchangeTable');
            tbody.innerHTML = '';

            Object.entries(exchangeStats).forEach(([exchange, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${exchange.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(stats.win_rate * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.total_trades}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${stats.pnl.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update strategy table
        function updateStrategyTable(strategyStats) {
            const tbody = document.getElementById('strategyTable');
            tbody.innerHTML = '';

            Object.entries(strategyStats).forEach(([strategy, stats]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${strategy}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(stats.win_rate * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.total_trades}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${stats.pnl.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        

        // Copy config change to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show a brief success message
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.classList.add('text-green-600');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('text-green-600');
                }, 2000);
            });
        }

        // Refresh data
        function refreshData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            fetchProfitabilityData();
        }

        // Run optimization
        async function runOptimization(autoApply = false) {
            const statusDiv = document.getElementById('optimizationStatus');
            const resultsDiv = document.getElementById('lastOptimization');
            
            // Show status
            statusDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/v1/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auto_apply: autoApply,
                        test_duration: 0
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Hide status
                statusDiv.classList.add('hidden');
                
                // Show results
                resultsDiv.classList.remove('hidden');
                displayOptimizationResults(result);
                
                // Refresh profitability data to show updated metrics
                fetchProfitabilityData();
                
            } catch (error) {
                console.error('Error running optimization:', error);
                statusDiv.classList.add('hidden');
                
                // Show error
                resultsDiv.classList.remove('hidden');
                document.getElementById('optimizationResults').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Error running optimization: ${error.message}
                    </div>
                `;
            }
        }
        
        // Display optimization results
        function displayOptimizationResults(result) {
            const resultsDiv = document.getElementById('optimizationResults');
            const comprehensiveDiv = document.getElementById('comprehensiveOutput');
            
            // Show comprehensive output
            comprehensiveDiv.classList.remove('hidden');
            
            if (result.config_changes && result.config_changes.changes.length > 0) {
                // Display summary
                displayOptimizationSummary(result.config_changes.summary);
                
                // Display detailed changes
                displayDetailedChanges(result.config_changes.changes);
                
                // Display config snippets
                document.getElementById('configSnippet').innerHTML = `<code>${result.config_changes.config_yaml_snippet}</code>`;
                document.getElementById('fullConfig').innerHTML = `<code>${result.config_changes.full_config_yaml}</code>`;
                
                // Update basic results
                resultsDiv.innerHTML = `
                    <div class="text-green-600">
                        <i class="fas fa-check-circle mr-1"></i>
                        Optimization completed! Found ${result.config_changes.summary.total_changes} recommended changes.
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="text-blue-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        No optimization changes needed - current settings are optimal!
                    </div>
                `;
                
                // Hide comprehensive output if no changes
                comprehensiveDiv.classList.add('hidden');
            }
        }
        
        // Display optimization summary
        function displayOptimizationSummary(summary) {
            const summaryDiv = document.getElementById('optimizationSummary');
            
            summaryDiv.innerHTML = `
                <div class="text-center p-3 bg-blue-50 rounded-md">
                    <div class="text-2xl font-bold text-blue-600">${summary.total_changes}</div>
                    <div class="text-sm text-blue-800">Total Changes</div>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-md">
                    <div class="text-2xl font-bold text-red-600">${summary.high_priority}</div>
                    <div class="text-sm text-red-800">High Priority</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded-md">
                    <div class="text-2xl font-bold text-yellow-600">${summary.medium_priority}</div>
                    <div class="text-sm text-yellow-800">Medium Priority</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-md">
                    <div class="text-2xl font-bold text-green-600">${summary.low_priority}</div>
                    <div class="text-sm text-green-800">Low Priority</div>
                </div>
            `;
        }
        
        // Display detailed changes
        function displayDetailedChanges(changes) {
            const changesDiv = document.getElementById('detailedChanges');
            
            let html = '';
            changes.forEach((change, index) => {
                const priorityColor = change.priority === 'high' ? 'border-red-200 bg-red-50' : 
                                    change.priority === 'medium' ? 'border-yellow-200 bg-yellow-50' : 
                                    'border-green-200 bg-green-50';
                
                const priorityText = change.priority === 'high' ? 'High Priority' : 
                                   change.priority === 'medium' ? 'Medium Priority' : 'Low Priority';
                
                html += `
                    <div class="border rounded-md p-3 ${priorityColor}">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-900">${change.category} - ${change.path}</h5>
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${
                                change.priority === 'high' ? 'bg-red-100 text-red-800' :
                                change.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-green-100 text-green-800'
                            }">${priorityText}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                            <div>
                                <span class="font-medium">Current:</span> 
                                <code class="bg-gray-100 px-1 rounded">${change.current_value}</code>
                            </div>
                            <div>
                                <span class="font-medium">Recommended:</span> 
                                <code class="bg-green-100 px-1 rounded">${change.recommended_value}</code>
                            </div>
                            <div>
                                <span class="font-medium">Confidence:</span> 
                                <span class="text-blue-600">${Math.round(change.confidence * 100)}%</span>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <i class="fas fa-lightbulb mr-1"></i>
                            ${change.expected_impact}
                        </div>
                    </div>
                `;
            });
            
            changesDiv.innerHTML = html;
        }
        
        // Copy config snippet to clipboard
        function copyConfigSnippet() {
            const snippet = document.getElementById('configSnippet').textContent;
            navigator.clipboard.writeText(snippet).then(() => {
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.classList.add('bg-green-600');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            });
        }
        
        // Copy full config to clipboard
        function copyFullConfig() {
            const fullConfig = document.getElementById('fullConfig').textContent;
            navigator.clipboard.writeText(fullConfig).then(() => {
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.classList.add('bg-green-600');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                }, 2000);
            });
        }
        
        // Check for existing optimization results on page load
        async function checkOptimizationStatus() {
            try {
                const response = await fetch('/api/v1/optimization/status');
                if (response.ok) {
                    const status = await response.json();
                    if (status.has_report) {
                        document.getElementById('lastOptimization').classList.remove('hidden');
                        document.getElementById('optimizationResults').innerHTML = `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p><strong>Last Run:</strong> ${new Date(status.last_optimization).toLocaleString()}</p>
                                    <p><strong>Total Optimizations:</strong> ${status.total_optimizations}</p>
                                    <p><strong>Applied Changes:</strong> ${status.applied_changes}</p>
                                </div>
                                <div>
                                    <p><strong>Expected Improvements:</strong></p>
                                    <ul class="list-disc list-inside ml-2">
                        `;
                        
                        for (const [metric, improvement] of Object.entries(status.expected_improvements || {})) {
                            if (improvement !== "0%") {
                                document.getElementById('optimizationResults').innerHTML += `<li>${metric}: ${improvement}</li>`;
                            }
                        }
                        
                        document.getElementById('optimizationResults').innerHTML += `
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking optimization status:', error);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            fetchProfitabilityData();
            checkOptimizationStatus();
            
            // Auto-refresh every 5 minutes
            setInterval(fetchProfitabilityData, 300000);
        });
    </script>
</body>
</html> 