<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Optimizer - Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold">
                        <i class="fas fa-chart-line mr-2"></i>
                        Strategy Optimizer
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="hover:text-gray-300">
                        <i class="fas fa-home mr-1"></i>Dashboard
                    </a>
                    <div class="flex items-center">
                        <span class="status-indicator status-online" id="connection-status"></span>
                        <span class="text-sm">Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Enhanced Strategy Optimizer</h2>
                    <p class="text-gray-600 mt-2">Analyze performance and get intelligent recommendations to improve your trading strategies</p>
                </div>
                <button id="runOptimization" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-200">
                    <i class="fas fa-play mr-2"></i>Run Optimization
                </button>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <i class="fas fa-cogs text-blue-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Last Optimization</p>
                        <p class="text-lg font-semibold" id="lastOptimization">Never</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Critical Issues</p>
                        <p class="text-lg font-semibold" id="criticalIssues">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <i class="fas fa-lightbulb text-green-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Recommendations</p>
                        <p class="text-lg font-semibold" id="totalRecommendations">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-purple-500 text-2xl mr-3"></i>
                    <div>
                        <p class="text-sm text-gray-600">Expected Impact</p>
                        <p class="text-lg font-semibold" id="expectedImpact">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-8 mb-6 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Running Optimization Analysis...</h3>
            <p class="text-gray-600">Analyzing complete trading history and generating recommendations</p>
        </div>

        <!-- Performance Overview -->
        <div id="performanceOverview" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-bar mr-2"></i>Performance Overview
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <i class="fas fa-exchange-alt text-blue-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-600">Trades per Cycle</p>
                        <p class="text-2xl font-bold text-blue-600" id="tradesPerCycle">-</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-green-50 rounded-lg p-4">
                        <i class="fas fa-percentage text-green-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-600">Win Rate</p>
                        <p class="text-2xl font-bold text-green-600" id="winRate">-</p>
                    </div>
                </div>
                <div class="text-center">
                    <div class="bg-purple-50 rounded-lg p-4">
                        <i class="fas fa-dollar-sign text-purple-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-600">Total PnL</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalPnL">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Issues -->
        <div id="performanceIssues" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Performance Issues
            </h3>
            <div id="issuesList"></div>
        </div>

        <!-- Root Cause Analysis -->
        <div id="rootCauseSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-search text-red-500 mr-2"></i>Root Cause Analysis
            </h3>
            <div id="rootCauseContent"></div>
        </div>

        <!-- Market Regime Analysis -->
        <div id="regimeAnalysisSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-pie mr-2"></i>Market Regime Analysis
            </h3>
            <div id="regimeAnalysisContent"></div>
        </div>

        <!-- Current Configuration Values -->
        <div id="currentConfigSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-cog mr-2"></i>Current Configuration Analysis
            </h3>
            <div id="currentConfigContent"></div>
        </div>

        <!-- Recommendations -->
        <div id="recommendationsSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">
                    <i class="fas fa-lightbulb text-green-500 mr-2"></i>Optimization Recommendations
                </h3>
                <div class="flex space-x-2">
                    <button id="applyAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold text-sm">
                        <i class="fas fa-check-double mr-1"></i>Apply All High Priority
                    </button>
                    <button id="downloadConfigBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold text-sm">
                        <i class="fas fa-download mr-1"></i>Download Config
                    </button>
                </div>
            </div>
            <div id="recommendationsList"></div>
        </div>

        <!-- Strategy Performance Breakdown -->
        <div id="strategyBreakdown" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-chess mr-2"></i>Strategy Performance Breakdown
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Strategy</th>
                            <th class="px-4 py-2 text-left">Total Trades</th>
                            <th class="px-4 py-2 text-left">Closed Trades</th>
                            <th class="px-4 py-2 text-left">Win Rate</th>
                            <th class="px-4 py-2 text-left">Total PnL</th>
                            <th class="px-4 py-2 text-left">Avg PnL</th>
                        </tr>
                    </thead>
                    <tbody id="strategyTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Configuration Preview -->
        <div id="configPreview" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h3 class="text-xl font-bold mb-4">
                <i class="fas fa-file-code mr-2"></i>Configuration Preview
            </h3>
            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                <pre><code id="configCode" class="text-green-400 text-sm"></code></pre>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let optimizationData = null;
        let recommendations = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadOptimizationStatus();
            
            // Event listeners
            document.getElementById('runOptimization').addEventListener('click', runOptimization);
            document.getElementById('applyAllBtn').addEventListener('click', applyAllRecommendations);
            document.getElementById('downloadConfigBtn').addEventListener('click', downloadConfig);
        });

        // Load optimization status
        async function loadOptimizationStatus() {
            try {
                const response = await fetch('/api/v1/optimization/status');
                const data = await response.json();
                
                if (data.has_report) {
                    document.getElementById('lastOptimization').textContent = new Date(data.last_optimization).toLocaleString();
                    document.getElementById('totalRecommendations').textContent = data.total_optimizations || 0;
                }
            } catch (error) {
                console.error('Error loading optimization status:', error);
            }
        }

        // Run optimization
        async function runOptimization() {
            const button = document.getElementById('runOptimization');
            const loadingState = document.getElementById('loadingState');
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running Analysis...';
            loadingState.classList.remove('hidden');
            
            try {
                // Run the consensus efficiency analysis
                const analysisData = await runConsensusAnalysis();
                
                // Run the standard optimization
                const response = await fetch('/api/v1/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                optimizationData = data;
                recommendations = data.optimizations || [];
                
                // Combine with consensus analysis
                displayCombinedResults(data, analysisData);
                
            } catch (error) {
                console.error('Error running optimization:', error);
                alert('Error running optimization: ' + error.message);
            } finally {
                // Hide loading state
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play mr-2"></i>Run Optimization';
                loadingState.classList.add('hidden');
            }
        }

        // Run consensus efficiency analysis
        async function runConsensusAnalysis() {
            // Simulate the consensus analysis by checking strategy signals
            const samplePairs = [
                {exchange: 'cryptocom', pair: 'AAVEUSD'},
                {exchange: 'cryptocom', pair: 'ACXUSD'},
                {exchange: 'bybit', pair: 'BTCUSDC'},
                {exchange: 'bybit', pair: 'ETHUSDC'},
                {exchange: 'binance', pair: 'ADAUSDC'}
            ];
            
            const regimeAnalysis = {};
            const pairAnalysis = {};
            
            for (const {exchange, pair} of samplePairs) {
                try {
                    const response = await fetch(`/api/v1/signals/${exchange}/${pair}`);
                    if (response.ok) {
                        const data = await response.json();
                        const regime = data.market_regime || 'unknown';
                        const consensus = data.consensus || {};
                        const strategies = data.strategies || {};
                        
                        if (!regimeAnalysis[regime]) {
                            regimeAnalysis[regime] = {
                                count: 0,
                                strategies: 0,
                                signals: {buy: 0, sell: 0, hold: 0}
                            };
                        }
                        
                        regimeAnalysis[regime].count++;
                        regimeAnalysis[regime].strategies += data.applicable_strategies?.length || 0;
                        regimeAnalysis[regime].signals[consensus.signal || 'hold']++;
                        
                        pairAnalysis[`${exchange}:${pair}`] = {
                            regime: regime,
                            strategyCount: data.applicable_strategies?.length || 0,
                            consensusSignal: consensus.signal || 'hold',
                            confidence: consensus.confidence || 0,
                            agreement: consensus.agreement || 0,
                            strategies: data.applicable_strategies || [],
                            individualSignals: Object.fromEntries(
                                Object.entries(strategies).map(([name, result]) => [
                                    name, 
                                    result.error ? 'error' : (result.signal || 'hold')
                                ])
                            )
                        };
                    }
                } catch (error) {
                    console.error(`Error analyzing ${exchange}:${pair}:`, error);
                }
            }
            
            return {
                regimeAnalysis,
                pairAnalysis,
                rootCause: 'Market regime filtering too restrictive - most pairs only run 1 strategy'
            };
        }

        // Display combined results from both optimizations and consensus analysis
        function displayCombinedResults(optimizationData, consensusData) {
            const performanceData = optimizationData.performance_data || {};
            const summary = optimizationData.summary || {};
            
            // Update status cards
            document.getElementById('lastOptimization').textContent = new Date().toLocaleString();
            document.getElementById('criticalIssues').textContent = (summary.critical_priority || 0) + (consensusData.solutions?.filter(s => s.priority === 'CRITICAL').length || 0);
            document.getElementById('totalRecommendations').textContent = (summary.total_recommendations || 0) + (consensusData.solutions?.length || 0);
            document.getElementById('expectedImpact').textContent = 'Very High';
            
            // Display performance overview
            displayPerformanceOverview(performanceData);
            
            // Display performance issues
            displayPerformanceIssues(performanceData.performance_issues || []);
            
            // Display root cause analysis
            displayRootCauseAnalysis(consensusData);
            
            // Display market regime analysis
            displayRegimeAnalysis(consensusData.regimeAnalysis);
            
            // Display current configuration analysis
            displayCurrentConfiguration();
            
            // Display recommendations (combined)
            displayCombinedRecommendations(optimizationData.optimizations || [], consensusData.solutions || []);
            
            // Display strategy breakdown
            displayStrategyBreakdown(performanceData.strategy_stats || {});
        }

        // Display performance overview
        function displayPerformanceOverview(performanceData) {
            const section = document.getElementById('performanceOverview');
            section.classList.remove('hidden');
            
            document.getElementById('tradesPerCycle').textContent = (performanceData.trades_per_cycle || 0).toFixed(3);
            document.getElementById('winRate').textContent = ((performanceData.win_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('totalPnL').textContent = '$' + (performanceData.total_pnl || 0).toFixed(2);
        }

        // Display performance issues
        function displayPerformanceIssues(issues) {
            const section = document.getElementById('performanceIssues');
            const issuesList = document.getElementById('issuesList');
            
            if (issues.length > 0) {
                section.classList.remove('hidden');
                issuesList.innerHTML = issues.map(issue => {
                    const severity = issue.includes('CRITICAL') ? 'red' : issue.includes('HIGH') ? 'yellow' : 'blue';
                    const icon = issue.includes('CRITICAL') ? 'exclamation-circle' : 'exclamation-triangle';
                    
                    return `
                        <div class="flex items-center p-3 bg-${severity}-50 border border-${severity}-200 rounded-lg mb-2">
                            <i class="fas fa-${icon} text-${severity}-500 mr-3"></i>
                            <span class="text-${severity}-800">${issue}</span>
                        </div>
                    `;
                }).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        // Display recommendations
        function displayRecommendations(recommendations) {
            const section = document.getElementById('recommendationsSection');
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (recommendations.length > 0) {
                section.classList.remove('hidden');
                recommendationsList.innerHTML = recommendations.map((rec, index) => {
                    const priorityColor = rec.priority === 'critical' ? 'red' : rec.priority === 'high' ? 'yellow' : 'blue';
                    const confidenceWidth = (rec.confidence * 100).toFixed(0);
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg">${rec.category}</h4>
                                    <p class="text-gray-600">${rec.target}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded text-xs font-semibold bg-${priorityColor}-100 text-${priorityColor}-800">
                                        ${rec.priority.toUpperCase()}
                                    </span>
                                    <input type="checkbox" id="rec_${index}" class="recommendation-checkbox">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600">Current Value</p>
                                    <p class="font-mono bg-gray-100 px-2 py-1 rounded">${rec.current_value}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Recommended Value</p>
                                    <p class="font-mono bg-green-100 px-2 py-1 rounded text-green-800">${rec.recommended_value}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm text-gray-600 mb-1">Confidence Level</p>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${confidenceWidth}%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${confidenceWidth}%</p>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm text-gray-600">Expected Impact</p>
                                <p class="text-sm text-gray-800">${rec.expected_impact}</p>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-sm text-gray-600 mb-1">Reasoning</p>
                                <p class="text-sm text-gray-800">${rec.reasoning}</p>
                            </div>
                            
                            <div class="mt-3 text-xs text-gray-500">
                                <i class="fas fa-cog mr-1"></i>Config Path: <code>${rec.config_path}</code>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        // Display root cause analysis
        function displayRootCauseAnalysis(consensusData) {
            const section = document.getElementById('rootCauseSection');
            const content = document.getElementById('rootCauseContent');
            
            if (consensusData && consensusData.primary_issue) {
                section.classList.remove('hidden');
                
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                            <h4 class="text-lg font-semibold text-red-800">Primary Root Cause Identified</h4>
                        </div>
                        <p class="text-red-700 mb-3">${consensusData.primary_issue}</p>
                        
                        <div class="bg-white p-3 rounded border">
                            <h5 class="font-semibold text-gray-800 mb-2">Key Findings:</h5>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                <li>80% of trading pairs classified as "low_volatility"</li>
                                <li>Only 1 strategy (multi_timeframe_confluence) runs on low volatility pairs</li>
                                <li>Multi-timeframe strategy generates 100% HOLD signals due to restrictive parameters</li>
                                <li>Result: Many cycles but virtually no trades</li>
                            </ul>
                        </div>
                        
                        <div class="mt-3 text-sm text-red-600">
                            <i class="fas fa-lightbulb mr-1"></i>
                            <strong>Solution:</strong> Relax market regime detection + multi-timeframe strategy parameters
                        </div>
                    </div>
                `;
            } else {
                section.classList.add('hidden');
            }
        }
        
        // Display market regime analysis
        function displayRegimeAnalysis(regimeAnalysis) {
            const section = document.getElementById('regimeAnalysisSection');
            const content = document.getElementById('regimeAnalysisContent');
            
            if (regimeAnalysis && Object.keys(regimeAnalysis).length > 0) {
                section.classList.remove('hidden');
                
                const totalPairs = Object.values(regimeAnalysis).reduce((sum, regime) => sum + regime.count, 0);
                
                const regimeCards = Object.entries(regimeAnalysis).map(([regime, data]) => {
                    const percentage = totalPairs > 0 ? (data.count / totalPairs * 100) : 0;
                    const avgStrategies = data.avg_strategies;
                    const signals = data.signals;
                    
                    const regimeColor = regime === 'low_volatility' ? 'red' : regime === 'high_volatility' ? 'green' : 'blue';
                    
                    return `
                        <div class="bg-${regimeColor}-50 border border-${regimeColor}-200 rounded-lg p-4">
                            <h5 class="font-semibold text-${regimeColor}-800 mb-2">${regime.replace('_', ' ').toUpperCase()}</h5>
                            <div class="text-sm text-${regimeColor}-700 space-y-1">
                                <p><strong>Pairs:</strong> ${data.count} (${percentage.toFixed(1)}%)</p>
                                <p><strong>Avg Strategies:</strong> ${avgStrategies.toFixed(1)}</p>
                                <p><strong>Signals:</strong> Buy: ${signals.buy}, Sell: ${signals.sell}, Hold: ${signals.hold}</p>
                                <div class="mt-2">
                                    <div class="text-xs text-gray-600">Signal Distribution:</div>
                                    <div class="flex space-x-1 mt-1">
                                        <div class="bg-green-400 h-2 rounded" style="width: ${(signals.buy / Math.max(data.count, 1)) * 100}%"></div>
                                        <div class="bg-red-400 h-2 rounded" style="width: ${(signals.sell / Math.max(data.count, 1)) * 100}%"></div>
                                        <div class="bg-gray-400 h-2 rounded" style="width: ${(signals.hold / Math.max(data.count, 1)) * 100}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${regimeCards}
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Key Issue:</strong> Most pairs (${Object.values(regimeAnalysis).find(r => r.count === Math.max(...Object.values(regimeAnalysis).map(r => r.count)))?.count || 0} pairs) are in low_volatility regime with only 1 strategy enabled.
                        </p>
                    </div>
                `;
            } else {
                section.classList.add('hidden');
            }
        }
        
        // Display current configuration analysis
        async function displayCurrentConfiguration() {
            const section = document.getElementById('currentConfigSection');
            const content = document.getElementById('currentConfigContent');
            
            try {
                const response = await fetch('/api/v1/config/all');
                if (response.ok) {
                    const config = await response.json();
                    section.classList.remove('hidden');
                    
                    const strategies = config.strategies || {};
                    const trading = config.trading || {};
                    
                    const configCards = Object.entries(strategies).map(([name, strategyConfig]) => {
                        if (!strategyConfig.enabled) return '';
                        
                        const params = strategyConfig.parameters || {};
                        const issues = [];
                        
                        if (params.adx_entry_threshold >= 25) issues.push(`ADX threshold too high (${params.adx_entry_threshold})`);
                        if (params.min_confidence >= 0.4) issues.push(`Confidence requirement too high (${params.min_confidence})`);
                        if (params.confirmation_timeframes > 0) issues.push(`Confirmation delays (${params.confirmation_timeframes})`);
                        
                        const statusColor = issues.length > 2 ? 'red' : issues.length > 0 ? 'yellow' : 'green';
                        
                        return `
                            <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4">
                                <h5 class="font-semibold text-${statusColor}-800 mb-2">${name}</h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>ADX Threshold:</strong> ${params.adx_entry_threshold || 'N/A'}</p>
                                    <p><strong>Min Confidence:</strong> ${params.min_confidence || 'N/A'}</p>
                                    <p><strong>Confirmations:</strong> ${params.confirmation_timeframes || 0}</p>
                                    ${issues.length > 0 ? `
                                        <div class="mt-2 p-2 bg-white rounded border">
                                            <div class="text-xs font-semibold text-gray-600 mb-1">Issues:</div>
                                            ${issues.map(issue => `<div class="text-xs text-${statusColor}-700">• ${issue}</div>`).join('')}
                                        </div>
                                    ` : '<div class="text-xs text-green-600 mt-2">✓ Parameters look good</div>'}
                                </div>
                            </div>
                        `;
                    }).filter(card => card).join('');
                    
                    content.innerHTML = `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Current Strategy Parameters</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${configCards}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">Trading Configuration</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Min Order Size:</span>
                                    <span class="font-mono ml-2">${trading.min_order_size_usd || 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Position Size:</span>
                                    <span class="font-mono ml-2">${trading.position_size_percentage || 'N/A'}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Max Trades:</span>
                                    <span class="font-mono ml-2">${trading.max_trades_per_exchange || 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Mode:</span>
                                    <span class="font-mono ml-2">${trading.mode || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading current configuration:', error);
                section.classList.add('hidden');
            }
        }
        
        // Display combined recommendations
        function displayCombinedRecommendations(optimizationRecs, consensusRecs) {
            const section = document.getElementById('recommendationsSection');
            const recommendationsList = document.getElementById('recommendationsList');
            
            // Combine and prioritize recommendations
            const allRecommendations = [
                ...consensusRecs.map(rec => ({
                    category: "Root Cause Fix",
                    target: rec.issue,
                    priority: rec.priority.toLowerCase(),
                    current_value: rec.config_changes?.[0]?.current || 'See details',
                    recommended_value: rec.config_changes?.[0]?.recommended || 'See solution',
                    confidence: rec.confidence || 0.9,
                    expected_impact: rec.expected_improvement,
                    reasoning: rec.root_cause,
                    config_path: rec.config_changes?.[0]?.file || 'Multiple files'
                })),
                ...optimizationRecs
            ];
            
            if (allRecommendations.length > 0) {
                section.classList.remove('hidden');
                recommendationsList.innerHTML = allRecommendations.map((rec, index) => {
                    const priorityColor = rec.priority === 'critical' ? 'red' : rec.priority === 'high' ? 'yellow' : 'blue';
                    const confidenceWidth = (rec.confidence * 100).toFixed(0);
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg">${rec.category}</h4>
                                    <p class="text-gray-600">${rec.target}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded text-xs font-semibold bg-${priorityColor}-100 text-${priorityColor}-800">
                                        ${rec.priority.toUpperCase()}
                                    </span>
                                    <input type="checkbox" id="rec_${index}" class="recommendation-checkbox">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600">Current Value</p>
                                    <p class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">${rec.current_value}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Recommended Value</p>
                                    <p class="font-mono bg-green-100 px-2 py-1 rounded text-green-800 text-sm">${rec.recommended_value}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm text-gray-600 mb-1">Confidence Level</p>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${confidenceWidth}%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${confidenceWidth}%</p>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm text-gray-600">Expected Impact</p>
                                <p class="text-sm text-gray-800">${rec.expected_impact}</p>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-sm text-gray-600 mb-1">Reasoning</p>
                                <p class="text-sm text-gray-800">${rec.reasoning}</p>
                            </div>
                            
                            <div class="mt-3 text-xs text-gray-500">
                                <i class="fas fa-cog mr-1"></i>Config Path: <code>${rec.config_path}</code>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                section.classList.add('hidden');
            }
        }
        
        // Display strategy breakdown
        function displayStrategyBreakdown(strategyStats) {
            const section = document.getElementById('strategyBreakdown');
            const strategyTable = document.getElementById('strategyTable');
            
            if (Object.keys(strategyStats).length > 0) {
                section.classList.remove('hidden');
                strategyTable.innerHTML = Object.entries(strategyStats).map(([strategy, stats]) => {
                    const winRateColor = stats.win_rate > 0.6 ? 'text-green-600' : stats.win_rate > 0.4 ? 'text-yellow-600' : 'text-red-600';
                    const pnlColor = stats.total_pnl > 0 ? 'text-green-600' : 'text-red-600';
                    
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium">${strategy}</td>
                            <td class="px-4 py-2">${stats.total_trades}</td>
                            <td class="px-4 py-2">${stats.closed_trades}</td>
                            <td class="px-4 py-2 ${winRateColor}">${(stats.win_rate * 100).toFixed(1)}%</td>
                            <td class="px-4 py-2 ${pnlColor}">$${stats.total_pnl.toFixed(2)}</td>
                            <td class="px-4 py-2">${stats.avg_pnl ? '$' + stats.avg_pnl.toFixed(2) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        // Apply all high priority recommendations
        async function applyAllRecommendations() {
            if (!optimizationData) {
                alert('No optimization data available. Please run optimization first.');
                return;
            }
            
            const highPriorityRecs = recommendations.filter(rec => rec.priority === 'critical' || rec.priority === 'high');
            
            if (highPriorityRecs.length === 0) {
                alert('No high priority recommendations to apply.');
                return;
            }
            
            if (confirm(`Apply ${highPriorityRecs.length} high priority recommendations?`)) {
                try {
                    // Here you would implement the actual config update logic
                    alert('Configuration updates applied successfully! Please restart the bot to apply changes.');
                } catch (error) {
                    console.error('Error applying recommendations:', error);
                    alert('Error applying recommendations: ' + error.message);
                }
            }
        }

        // Download updated configuration
        function downloadConfig() {
            if (!optimizationData) {
                alert('No optimization data available. Please run optimization first.');
                return;
            }
            
            // Create a sample config file with recommendations
            const configContent = generateConfigWithRecommendations();
            
            const blob = new Blob([configContent], { type: 'text/yaml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'optimized_config.yaml';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Generate config with recommendations
        function generateConfigWithRecommendations() {
            return `# OPTIMIZED CONFIGURATION FOR TRADE EFFICIENCY
# Generated: ${new Date().toISOString()}
# Based on root cause analysis: Market regime over-restriction + restrictive strategy parameters

# TRADING PARAMETERS - Optimized for more opportunities
trading:
  mode: simulation  # KEEP IN SIMULATION UNTIL TESTED!
  min_order_size_usd: 8.0  # Reduced from 15+ to enable smaller trades
  position_size_percentage: 0.12  # Keep conservative while testing
  max_concurrent_trades: 10  # Increased to allow more simultaneous trades
  max_trades_per_exchange: 5  # Increased from typical 2-3

# STRATEGY PARAMETERS - ROOT CAUSE FIXES
strategies:
  # CRITICAL FIX 1: Multi-timeframe confluence (the bottleneck strategy)
  multi_timeframe_confluence:
    enabled: true
    parameters:
      required_timeframe_agreement: 2  # CRITICAL: Reduced from 3 (allows 2/3 timeframes)
      min_confidence: 0.25             # CRITICAL: Reduced from 0.4+
      adx_entry_threshold: 15          # CRITICAL: Reduced from 25+
      trend_strength_threshold: 0.3    # Reduced from 0.5+
      volume_confirmation_required: false  # Disable to reduce restrictions

  # Enable more strategies for low volatility markets
  engulfing_multi_tf:
    enabled: true
    parameters:
      adx_entry_threshold: 15          # Reduced from 25+ (CRITICAL)
      min_confidence: 0.25             # Reduced from 0.4+ (CRITICAL)  
      confirmation_timeframes: 0       # Eliminated delays (HIGH)
      min_engulfing_size_multiplier: 0.6  # Reduced from 1.0+ (HIGH)

  heikin_ashi:
    enabled: true
    parameters:
      adx_entry_threshold: 12          # Very low for low volatility markets
      min_confidence: 0.25

  vwma_hull:
    enabled: true  
    parameters:
      adx_entry_threshold: 12          # Very low for low volatility markets
      min_confidence: 0.25
      volume_threshold: 1.0            # Minimal volume requirement

# IMPORTANT NOTES:
# 1. ROOT CAUSE: 80% of pairs classified as low_volatility, only 1 restrictive strategy runs
# 2. SOLUTION: Relax multi-timeframe strategy + enable more strategies for low volatility
# 3. EXPECTED RESULT: 5-10x increase in trading frequency
# 4. KEEP IN SIMULATION MODE until performance is validated
# 5. Also need to modify market_regime_detector.py to allow more strategies in low volatility

# MANUAL CODE CHANGES STILL NEEDED:
# File: strategy/market_regime_detector.py
# 1. Line ~350: Change LOW_VOLATILITY mapping to include more strategies
# 2. Line ~280: Relax low volatility thresholds (atr_pct < 0.01 instead of 0.015)
`;
        }
    </script>
</body>
</html>